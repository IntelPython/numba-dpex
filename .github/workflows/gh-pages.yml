name: GitHub Pages
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    # paths:
    #   - 'docs/**'
    #   - environment/docs.yml

jobs:
  main:
    if: ${{ !(github.event.pull_request && github.event.action == 'closed') }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup numba-dpex
        uses: ./.github/actions/setup-numba-dpex
        with:
          environment: environment/docs.yml

      - name: Make documentation
        working-directory: docs
        run: make html

      - name: GitHub Pages [main]
        if: ${{ github.ref == 'refs/heads/main' && github.repository == 'IntelPython/numba-dppy' }}
        shell: bash -l {0}
        run: |
          git remote add tokened_docs https://IntelPython:${{ secrets.GITHUB_TOKEN }}@github.com/IntelPython/numba-dppy.git
          git fetch tokened_docs
          git checkout --track tokened_docs/gh-pages
          echo `pwd`
          cd main
          git rm -rf *
          mv ./docs/_build/html/ . || exit 1
          git add .
          git config --global user.name 'github-actions[doc-deploy-bot]'
          git config --global user.email 'github-actions[doc-deploy-bot]@users.noreply.github.com'
          git commit -m "Latest docs."
          git push tokened_docs gh-pages

      - name: GitHub Pages [PR]
        if: ${{ github.event.pull_request && github.event.action != 'closed' && github.repository == 'IntelPython/numba-dppy' }}
        env:
          PR_NUM: ${{ github.event.number }}
        shell: bash -l {0}
        run: |
          git remote add tokened_docs https://IntelPython:${{ secrets.GITHUB_TOKEN }}@github.com/IntelPython/numba-dppy.git
          git fetch tokened_docs
          git checkout --track tokened_docs/gh-pages
          echo `pwd`
          [ -d pulls/${PR_NUM} ] && git rm -rf pulls/${PR_NUM}
          mkdir -p pulls/${PR_NUM}
          cd pulls/${PR_NUM}
          mv ./docs/_build/html/ . || exit 1
          git add .
          git config --global user.name 'github-actions[doc-deploy-bot]'
          git config --global user.email 'github-actions[doc-deploy-bot]@users.noreply.github.com'
          git commit -m "Docs for pull request ${PR_NUM}"
          git push tokened_docs gh-pages

      - name: Comment PR [docs created]
        if: ${{ github.event.pull_request && github.event.action != 'closed' && github.repository == 'IntelPython/numba-dppy' }}
        env:
          PR_NUM: ${{ github.event.number }}
        uses: mshick/add-pr-comment@v1
        with:
          message: |
            Documentation preview: [show](https://intelpython.github.io/numba-dppy/pull/${{ env.PR_NUM }}).
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'
          allow-repeats: false

  clean:
    if: ${{ github.event.pull_request && github.event.action == 'closed' && github.repository == 'IntelPython/numba-dppy' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: GitHub Pages [PR closed]
        env:
          PR_NUM: ${{ github.event.number }}
        shell: bash -l {0}
        run: |
          git remote add tokened_docs https://IntelPython:${{ secrets.GITHUB_TOKEN }}@github.com/IntelPython/numba-dppy.git
          git fetch tokened_docs
          git checkout --track tokened_docs/gh-pages
          echo `pwd`
          [ -d pull/${PR_NUM} ] && git rm -rf pull/${PR_NUM}
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "Removing docs for closed pull request ${PR_NUM}"
          git push tokened_docs gh-pages

      - name: Comment PR [docs removed]
        uses: mshick/add-pr-comment@v1
        with:
          message: |
             Deleted rendered PR docs from intelpython.github.com/dpctl, latest should be updated shortly. :crossed_fingers:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'
          allow-repeats: true
