<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPNP integration &mdash; numba-dppy 0+untagged.710.g3cde87b documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Debugging the compilation pipeline" href="tools.html" />
    <link rel="prev" title="numba-dppy For numba.cuda Developers" href="../user_guides/migrating_from_numba_cuda.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> numba-dppy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CoreFeatures.html">Code-generation based on a device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CoreFeatures.html#automatic-offload-of-numpy-expressions">Automatic offload of NumPy expressions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guides/getting_started.html"> Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides/kernel_programming_guide/index.html"> Programming SYCL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides/debugging/index.html"> Debugging with GDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides/migrating_from_numba_cuda.html"> numba-dppy for numba.cuda Programmers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guides</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">DPNP integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#integration-with-dpnp-backend-library">Integration with DPNP backend library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#repository-map">Repository map</a></li>
<li class="toctree-l3"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#places-to-update">Places to update</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-overload-for-stub-function">Writing overload for stub function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#types-matching-for-numba-and-dpnp">Types matching for Numba and DPNP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-dpnp-integration-tests">Writing <cite>DPNP</cite> integration tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Debugging the compilation pipeline</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">numba-dppy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>DPNP integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer_guides/dpnp_integration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dpnp-integration">
<span id="id1"></span><h1>DPNP integration<a class="headerlink" href="#dpnp-integration" title="Permalink to this headline"></a></h1>
<p>Currently <cite>numba-dppy</cite> uses <a class="reference external" href="https://github.com/IntelPython/dpnp/tree/master/dpnp/backend">DPNP backend library</a>.</p>
<section id="integration-with-dpnp-backend-library">
<span id="integration-dpnp-backend"></span><h2>Integration with <a class="reference external" href="https://github.com/IntelPython/dpnp/tree/master/dpnp/backend">DPNP backend library</a><a class="headerlink" href="#integration-with-dpnp-backend-library" title="Permalink to this headline"></a></h2>
<p><cite>numba-dppy</cite> replaces <cite>NumPy</cite> function calls with <cite>DPNP</cite> function calls.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span> <span class="nn">dpctl</span>

<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># this call will be replaced with DPNP function</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="k">with</span> <span class="n">dpctl</span><span class="o">.</span><span class="n">device_context</span><span class="p">():</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="samp docutils literal notranslate"><span class="pre">np.sum(a)</span></code> will be replaced with <a class="reference external" href="https://github.com/IntelPython/dpnp/blob/ef404c0f284b0c508ed1e556e140f02f76ae5551/dpnp/backend/kernels/dpnp_krnl_reduction.cpp#L58">dpnp_sum_c&lt;int, int&gt;(…)</a>.</p>
<section id="repository-map">
<span id="dpnp-integration-repository-map"></span><h3>Repository map<a class="headerlink" href="#repository-map" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Code for integration is mostly resides in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface</span></code>.</p></li>
<li><p>Tests resides in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/tests/njit_tests/dpnp</span></code>.</p></li>
<li><p>Helper pass resides in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/rename_numpy_functions_pass.py</span></code>.</p></li>
</ul>
</section>
<section id="architecture">
<span id="dpnp-integration-architecture"></span><h3>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline"></a></h3>
<p><cite>numba-dppy</cite> modifies default <cite>Numba</cite> compiler pipeline and extends it with
<code class="xref py py-class docutils literal notranslate"><span class="pre">DPPYRewriteOverloadedNumPyFunctions</span></code> pass.</p>
<p>The main work is performed in <code class="xref py py-class docutils literal notranslate"><span class="pre">RewriteNumPyOverloadedFunctions</span></code> used by the pass.
It rewrites call for <cite>NumPy</cite> function in following way:</p>
<blockquote>
<div><p><code class="samp docutils literal notranslate"><span class="pre">np.sum(a)</span></code> -&gt; <code class="samp docutils literal notranslate"><span class="pre">numba_dppy.dpnp.sum(a)</span></code></p>
</div></blockquote>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">numba_dppy.dpnp</span></code> contains stub functions (defined as classes) like following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># numba_dppy/dpnp_iface/stubs.py - imported in numba_dppy.__init__.py</span>

<span class="k">class</span> <span class="nc">dpnp</span><span class="p">(</span><span class="n">Stub</span><span class="p">):</span>

  <span class="k">class</span> <span class="nc">sum</span><span class="p">(</span><span class="n">Stub</span><span class="p">):</span>  <span class="c1"># stub function</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>For the stub function call to be lowered with <cite>Numba</cite> compiler pipeline there
is overload in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/dpnp_transcendentalsimpl.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@overload</span><span class="p">(</span><span class="n">stubs</span><span class="o">.</span><span class="n">dpnp</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dpnp_sum_impl</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>Overload implementation knows about <cite>DPNP</cite> functions.
It receives <cite>DPNP</cite> function pointer from <cite>DPNP</cite> and uses known signature from <cite>DPNP</cite> headers.
The implementation calls <cite>DPNP</cite> function via creating <cite>Numba</cite> <code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalFunctionPointer</span></code>.</p>
<p>For more details about overloads implementation see <a class="reference internal" href="#overload-for-stub"><span class="std std-ref">Writing overload for stub function</span></a>.</p>
<p>For more details about testing the integration see <a class="reference internal" href="#dpnp-integration-tests"><span class="std std-ref">Writing DPNP integration tests</span></a>.</p>
</section>
<section id="places-to-update">
<span id="dpnp-integration-places"></span><h3>Places to update<a class="headerlink" href="#places-to-update" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/stubs.py</span></code>: Add new class to <code class="xref py py-class docutils literal notranslate"><span class="pre">stubs.dpnp</span></code> class.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/dpnp_fptr_interface.pyx</span></code>: Update items in <code class="xref py py-class docutils literal notranslate"><span class="pre">DPNPFuncName</span></code> enum.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/dpnp_fptr_interface.pyx</span></code>: Update if statements in <code class="xref py py-func docutils literal notranslate"><span class="pre">get_DPNPFuncName_from_str()</span></code> function.</p></li>
<li><p>Add <code class="samp docutils literal notranslate"><span class="pre">&#64;overload(stubs.dpnp.</span><em><span class="pre">YOUR_FUNCTION</span></em><span class="pre">)</span></code> in one of the <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/</span><em><span class="pre">*</span></em><span class="pre">.py</span></code> modules or create new.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">numba_dppy/rename_numpy_functions_pass.py</span></code>: Update items in <code class="xref py py-obj docutils literal notranslate"><span class="pre">rewrite_function_name_map</span></code> dict.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">numba_dppy/rename_numpy_functions_pass.py</span></code>: Update imported modules in <code class="xref py py-meth docutils literal notranslate"><span class="pre">DPPYRewriteOverloadedNumPyFunctions.__init__()</span></code>.</p></li>
<li><p>Add test in one of the <code class="file docutils literal notranslate"><span class="pre">numba_dppy/tests/njit_tests/dpnp</span></code> test modules or create new.</p></li>
</ol>
</section>
<section id="writing-overload-for-stub-function">
<span id="overload-for-stub"></span><h3>Writing overload for stub function<a class="headerlink" href="#writing-overload-for-stub-function" title="Permalink to this headline"></a></h3>
<p>Overloads for stub functions resides in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/</span><em><span class="pre">*</span></em><span class="pre">.py</span></code> modules.
If you need create new module try to name it corresponding to <cite>DPNP</cite> naming.
I.e. <code class="file docutils literal notranslate"><span class="pre">dpnp/backend/kernels/dpnp_krnl_indexing.cpp</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/dpnp_indexing.py</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba.core.extending</span> <span class="kn">import</span> <span class="n">overload</span>
<span class="kn">import</span> <span class="nn">numba_dppy.dpnp_iface</span> <span class="k">as</span> <span class="nn">dpnp_lowering</span>
<span class="o">...</span>

<span class="nd">@overload</span><span class="p">(</span><span class="n">stubs</span><span class="o">.</span><span class="n">dpnp</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dpnp_sum_impl</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">dpnp_lowering</span><span class="o">.</span><span class="n">ensure_dpnp</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">ensure_dpnp()</span></code> checks that <cite>DPNP</cite> package is available and contains the function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">numba.core.typing</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="o">...</span>
<span class="c1"># continue of dpnp_sum_impl()</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  dpnp source:</span>
<span class="sd">  https://github.com/IntelPython/dpnp/blob/0.6.1dev/dpnp/backend/kernels/dpnp_krnl_reduction.cpp#L59</span>

<span class="sd">  Function declaration:</span>
<span class="sd">  void dpnp_sum_c(void* result_out,</span>
<span class="sd">                  const void* input_in,</span>
<span class="sd">                  const size_t* input_shape,</span>
<span class="sd">                  const size_t input_shape_ndim,</span>
<span class="sd">                  const long* axes,</span>
<span class="sd">                  const size_t axes_ndim,</span>
<span class="sd">                  const void* initial,</span>
<span class="sd">                  const long* where)</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span>
      <span class="n">types</span><span class="o">.</span><span class="n">void</span><span class="p">,</span>  <span class="c1"># return type</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># void* result_out,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># const void* input_in,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># const size_t* input_shape,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">intp</span><span class="p">,</span>  <span class="c1"># const size_t input_shape_ndim,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># const long* axes,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">intp</span><span class="p">,</span>  <span class="c1"># const size_t axes_ndim,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># const void* initial,</span>
      <span class="n">types</span><span class="o">.</span><span class="n">voidptr</span><span class="p">,</span>  <span class="c1"># const long* where)</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>Signature <code class="xref py py-obj docutils literal notranslate"><span class="pre">sig</span></code> is based on the <cite>DPNP</cite> function signature defined in header file.
It is recommended to provide link to signature in <cite>DPNP</cite> sources and copy it in comment
as shown above.</p>
<p>For mapping between <cite>C</cite> types and <cite>Numba</cite> types see <a class="reference internal" href="#dpnp-integration-types-matching"><span class="std std-ref">Types matching for Numba and DPNP</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba_dppy.dpnp_iface.dpnpimpl</span> <span class="k">as</span> <span class="nn">dpnp_ext</span>
<span class="o">...</span>
<span class="c1"># continue of dpnp_sum_impl()</span>
  <span class="n">dpnp_func</span> <span class="o">=</span> <span class="n">dpnp_ext</span><span class="o">.</span><span class="n">dpnp_func</span><span class="p">(</span><span class="s2">&quot;dpnp_sum&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">],</span> <span class="n">sig</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">dpnp_ext.dpnp_func()</span></code> returns function pointer from <cite>DPNP</cite>.
It receives:</p>
<ul class="simple">
<li><p>Function name (i.e. <code class="samp docutils literal notranslate"><span class="pre">&quot;dpnp_sum&quot;</span></code>) which is converted to
<code class="xref py py-class docutils literal notranslate"><span class="pre">DPNPFuncName</span></code> enum in <code class="xref py py-func docutils literal notranslate"><span class="pre">get_DPNPFuncName_from_str()</span></code>.</p></li>
<li><p>List of input and output data types names
(i.e. <code class="samp docutils literal notranslate"><span class="pre">[a.dtype.name,</span> <span class="pre">&quot;NONE&quot;]</span></code>, <code class="samp docutils literal notranslate"><span class="pre">&quot;NONE&quot;</span></code> means reusing previous type name)
which is converted to <code class="xref py py-class docutils literal notranslate"><span class="pre">DPNPFuncType</span></code> enum in <code class="xref py py-func docutils literal notranslate"><span class="pre">get_DPNPFuncType_from_str()</span></code>.</p></li>
<li><p>Signature which is used for creating <cite>Numba</cite> <code class="xref py py-class docutils literal notranslate"><span class="pre">ExternalFunctionPointer</span></code>.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba_dppy.dpnp_iface.dpnpimpl</span> <span class="k">as</span> <span class="nn">dpnp_ext</span>
<span class="o">...</span>
<span class="c1"># continue of dpnp_sum_impl()</span>
  <span class="n">PRINT_DEBUG</span> <span class="o">=</span> <span class="n">dpnp_lowering</span><span class="o">.</span><span class="n">DEBUG</span>

  <span class="k">def</span> <span class="nf">dpnp_impl</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
      <span class="n">common_impl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">dpnp_func</span><span class="p">,</span> <span class="n">PRINT_DEBUG</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">dpnp_impl</span>
</pre></div>
</div>
<p>This code created implementation function and returns it from the overload function.</p>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">PRINT_DEBUG</span></code> used for printing debug information which is used in tests.
Tests rely on debug information to check that DPNP implementation was used.
See <a class="reference internal" href="#dpnp-integration-tests"><span class="std std-ref">Writing DPNP integration tests</span></a>.</p>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">dpnp_impl()</span></code> creates output array with size and data type corresponding
to <cite>DPNP</cite> function output array.</p>
<p><code class="xref py py-func docutils literal notranslate"><span class="pre">dpnp_impl()</span></code> could call <cite>NumPy</cite> functions supported by <cite>Numba</cite> and
other stab functions (i.e. <code class="xref py py-func docutils literal notranslate"><span class="pre">numba_dppy.dpnp.dot()</span></code>).</p>
<p>The implementation function usually reuse a common function like <code class="xref py py-func docutils literal notranslate"><span class="pre">common_impl()</span></code>.
This approach eliminates code duplication.
You should consider all available common functions at the top of the file before
creating the new one.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba.core.extending</span> <span class="kn">import</span> <span class="n">register_jitable</span>
<span class="kn">from</span> <span class="nn">numba_dppy</span> <span class="kn">import</span> <span class="n">dpctl_functions</span>
<span class="kn">import</span> <span class="nn">numba_dppy.dpnp_iface.dpnpimpl</span> <span class="k">as</span> <span class="nn">dpnp_ext</span>
<span class="o">...</span>

<span class="nd">@register_jitable</span>
<span class="k">def</span> <span class="nf">common_impl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">dpnp_func</span><span class="p">,</span> <span class="n">print_debug</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passed Empty array&quot;</span><span class="p">)</span>

    <span class="n">sycl_queue</span> <span class="o">=</span> <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">get_current_queue</span><span class="p">()</span>
    <span class="n">a_usm</span> <span class="o">=</span> <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">malloc_shared</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">sycl_queue</span><span class="p">)</span>  <span class="c1"># 1</span>
    <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">queue_memcpy</span><span class="p">(</span><span class="n">sycl_queue</span><span class="p">,</span> <span class="n">a_usm</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">ctypes</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>  <span class="c1"># 2</span>

    <span class="n">out_usm</span> <span class="o">=</span> <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">malloc_shared</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">sycl_queue</span><span class="p">)</span>  <span class="c1"># 1</span>

    <span class="n">axes</span><span class="p">,</span> <span class="n">axes_ndim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">where</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">dpnp_func</span><span class="p">(</span><span class="n">out_usm</span><span class="p">,</span> <span class="n">a_usm</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shapeptr</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">axes_ndim</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>  <span class="c1"># 3</span>

    <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">queue_memcpy</span><span class="p">(</span>
        <span class="n">sycl_queue</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">ctypes</span><span class="p">,</span> <span class="n">out_usm</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">out</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="p">)</span>  <span class="c1"># 4</span>

    <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">free_with_queue</span><span class="p">(</span><span class="n">a_usm</span><span class="p">,</span> <span class="n">sycl_queue</span><span class="p">)</span>  <span class="c1"># 5</span>
    <span class="n">dpctl_functions</span><span class="o">.</span><span class="n">free_with_queue</span><span class="p">(</span><span class="n">out_usm</span><span class="p">,</span> <span class="n">sycl_queue</span><span class="p">)</span>  <span class="c1"># 5</span>

    <span class="n">dpnp_ext</span><span class="o">.</span><span class="n">_dummy_liveness_func</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>  <span class="c1"># 6</span>

    <span class="k">if</span> <span class="n">print_debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dpnp implementation&quot;</span><span class="p">)</span>  <span class="c1"># 7</span>
</pre></div>
</div>
<p>Key parts of any common function are:</p>
<ol class="arabic simple">
<li><p>Allocate input and output USM arrays</p></li>
<li><p>Copy input array to input USM array</p></li>
<li><p>Call <code class="xref py py-func docutils literal notranslate"><span class="pre">dpnp_func()</span></code></p></li>
<li><p>Copy output USM array to output array</p></li>
<li><p>Deallocate USM arrays</p></li>
<li><p>Disable dead code elimination for input and output arrays</p></li>
<li><p>Print debug information used for testing</p></li>
</ol>
<section id="types-matching-for-numba-and-dpnp">
<span id="dpnp-integration-types-matching"></span><h4>Types matching for Numba and DPNP<a class="headerlink" href="#types-matching-for-numba-and-dpnp" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">[const]</span> <em><span class="pre">T</span></em><span class="pre">*</span></code> -&gt; <code class="xref py py-obj docutils literal notranslate"><span class="pre">types.voidptr</span></code></p></li>
<li><p><cite>size_t</cite> -&gt; <code class="xref py py-obj docutils literal notranslate"><span class="pre">types.intp</span></code></p></li>
<li><p><cite>long</cite> -&gt; <code class="xref py py-obj docutils literal notranslate"><span class="pre">types.int64</span></code></p></li>
</ul>
<p>We are using <cite>void *</cite> in case of <cite>size_t *</cite> as <cite>Numba</cite> currently does not have
any type to represent <cite>size_t *</cite>.
Since, both the types are pointers, if the compiler allows there should not be
any mismatch in the size of the container to hold different types of pointer.</p>
</section>
</section>
<section id="writing-dpnp-integration-tests">
<span id="dpnp-integration-tests"></span><h3>Writing <cite>DPNP</cite> integration tests<a class="headerlink" href="#writing-dpnp-integration-tests" title="Permalink to this headline"></a></h3>
<p>See all <cite>DPNP</cite> integration tests in <code class="file docutils literal notranslate"><span class="pre">numba_dppy/tests/njit_tests/dpnp</span></code>.</p>
<p>Usually adding new test is as easy as adding function name to the corresponding list of function names.
Each item in the list is used as a parameter for tests.
You should find tests for the category of functions similar to your function and
update a list with function names like <code class="xref py py-obj docutils literal notranslate"><span class="pre">list_of_unary_ops</span></code>, <code class="xref py py-obj docutils literal notranslate"><span class="pre">list_of_nan_ops</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;filter_str&quot;</span><span class="p">,</span> <span class="n">filter_strings</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_unary_ops</span><span class="p">(</span><span class="n">filter_str</span><span class="p">,</span> <span class="n">unary_op</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">get_shape</span><span class="p">,</span> <span class="n">capfd</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">input_array</span>  <span class="c1"># 1</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">get_shape</span><span class="p">)</span>
  <span class="n">op</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">unary_op</span>  <span class="c1"># 2</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cumprod&quot;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cumsum&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
      <span class="n">filter_str</span> <span class="o">==</span> <span class="s2">&quot;opencl:cpu:0&quot;</span> <span class="ow">or</span> <span class="n">is_gen12</span><span class="p">(</span><span class="n">filter_str</span><span class="p">)</span>
  <span class="p">):</span>
      <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">()</span>
  <span class="n">actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="n">f</span> <span class="o">=</span> <span class="n">njit</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>  <span class="c1"># 3</span>
  <span class="k">with</span> <span class="n">dpctl</span><span class="o">.</span><span class="n">device_context</span><span class="p">(</span><span class="n">filter_str</span><span class="p">),</span> <span class="n">dpnp_debug</span><span class="p">():</span>  <span class="c1"># 7</span>
      <span class="n">actual</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># 4</span>
      <span class="n">captured</span> <span class="o">=</span> <span class="n">capfd</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
      <span class="k">assert</span> <span class="s2">&quot;dpnp implementation&quot;</span> <span class="ow">in</span> <span class="n">captured</span><span class="o">.</span><span class="n">out</span>  <span class="c1"># 8</span>

  <span class="n">expected</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># 5</span>
  <span class="n">max_abs_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">max_abs_err</span> <span class="o">&lt;</span> <span class="mf">1e-4</span>  <span class="c1"># 6</span>
</pre></div>
</div>
<p>Test functions starts from <code class="samp docutils literal notranslate"><span class="pre">test_</span></code> (see <cite>pytest</cite> docs) and
all input parameters are provided by fixtures.</p>
<p>In example above <code class="xref py py-obj docutils literal notranslate"><span class="pre">unary_op</span></code> contains tuple <code class="samp docutils literal notranslate"><span class="pre">(</span><em><span class="pre">FUNCTION</span></em><span class="pre">,</span> <em><span class="pre">FUNCTION_NAME</span></em><span class="pre">)</span></code>,
see fixture <code class="xref py py-func docutils literal notranslate"><span class="pre">unary_op()</span></code>.</p>
<p>Key parts of any test are:</p>
<ol class="arabic simple">
<li><p>Receive input array from the fixture <code class="xref py py-obj docutils literal notranslate"><span class="pre">input_array</span></code></p></li>
<li><p>Receive the tested function from fixture <code class="xref py py-obj docutils literal notranslate"><span class="pre">unary_op</span></code></p></li>
<li><p>Compile the tested function with <code class="xref py py-func docutils literal notranslate"><span class="pre">njit()</span></code></p></li>
<li><p>Call the compiled tested function inside <code class="xref py py-func docutils literal notranslate"><span class="pre">device_context()</span></code> device_context
and receive <code class="xref py py-obj docutils literal notranslate"><span class="pre">actual</span></code> result</p></li>
<li><p>Call the original tested function and receive <code class="xref py py-obj docutils literal notranslate"><span class="pre">expected</span></code> result</p></li>
<li><p>Compare <code class="xref py py-obj docutils literal notranslate"><span class="pre">actual</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">expected</span></code> result</p></li>
<li><p>Run the compiled test function inside debug contex <code class="xref py py-func docutils literal notranslate"><span class="pre">dpnp_debug()</span></code></p></li>
<li><p>Check that <cite>DPNP</cite> was usede as debug information was printed to output</p></li>
</ol>
</section>
<section id="troubleshooting">
<span id="dpnp-troubleshooting"></span><h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Do not forget build <cite>numba-dppy</cite> with current installed version of <cite>DPNP</cite>.
There is headers dependency in <cite>Cython</cite> files (i.e. <code class="file docutils literal notranslate"><span class="pre">numba_dppy/dpnp_iface/dpnp_fptr_interface.pyx</span></code>).</p></li>
<li><p>Do not forget add array to <code class="samp docutils literal notranslate"><span class="pre">dpnp_ext._dummy_liveness_func([</span><em><span class="pre">YOUR_ARRAY</span></em><span class="pre">.size])</span></code>.
Dead code elimination could delete temporary variables before they are used for <cite>DPNP</cite> function call.
As a result wrong data could be passed to <cite>DPNP</cite> function.</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../user_guides/migrating_from_numba_cuda.html" class="btn btn-neutral float-left" title="numba-dppy For numba.cuda Developers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools.html" class="btn btn-neutral float-right" title="Debugging the compilation pipeline" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>