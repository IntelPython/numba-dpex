
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Memory Management &#8212; Data Parallel Extensions for Python* 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sdc.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Synchronization Functions" href="synchronization.html" />
    <link rel="prev" title="Writing Data Parallel Kernels" href="writing_kernels.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Intel Python projects" href="../../other_intel_python_projects.html"></a>
  <a class="brand_sdc" title="Documentation Home" href="../../index.html"></a>

  <ul>
    <li><a class="exampleslink" title="Examples" href="../../examples.html"></a></li>
    <li><a class="issueslink" title="Issues" href="https://community.intel.com/t5/Intel-Distribution-for-Python/bd-p/distribution-python"></a></li>
    <li><a class="emaillink" title="Email" href="mailto:scripting@intel.com"></a></li>
    <li><a class="homelink" title="GitHub" href="https://github.com/IntelPython/numba-dpex"></a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="synchronization.html" title="Synchronization Functions">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="writing_kernels.html" title="Writing Data Parallel Kernels">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../index.html">Data Parallel Extensions for Python* 0.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" >Data Parallel Extension for Numba User Manual</a> &#187;</li>
      <li><a href="index.html" accesskey="U">Data Parallel Kernel Programming</a> &#187;</li>
      
      <li>Memory Management</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <span class="target" id="memory-management"></span><section id="id1">
<h1>Memory Management<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<p>Numba-dpex uses DPC++’s USM shared memory allocator (<code class="docutils literal notranslate"><span class="pre">memory_alloc</span></code>) to
enable host to device and <em>vice versa</em> data transfer. By using USM shared
memory allocator, numba-dpex allows seamless interoperability between
numba-dpex and other SYCL-based Python extensions and across multiple
kernels written using <code class="docutils literal notranslate"><span class="pre">numba_dpex.kernel</span></code> decorator.</p>
<p>Numba-dpex uses the USM memory manager provided by dpctl and supports
the <strong>SYCL USM Array Interface</strong> protocol to enable zero-copy data
exchange across USM memory-backed Python objects.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>USM pointers make sense within a SYCL context and can be of four allocation
types: <code class="docutils literal notranslate"><span class="pre">host</span></code>, <code class="docutils literal notranslate"><span class="pre">device</span></code>, <code class="docutils literal notranslate"><span class="pre">shared</span></code>, or <code class="docutils literal notranslate"><span class="pre">unknown</span></code>. Host applications,
including CPython interpreter, can work with USM pointers of type <code class="docutils literal notranslate"><span class="pre">host</span></code>
and <code class="docutils literal notranslate"><span class="pre">shared</span></code> as if they were ordinary host pointers. Accessing <code class="docutils literal notranslate"><span class="pre">device</span></code>
USM pointers by host applications is not allowed.</p>
</div>
<section id="sycl-usm-array-interface">
<h2>SYCL USM Array Interface<a class="headerlink" href="#sycl-usm-array-interface" title="Permalink to this heading">¶</a></h2>
<p>A SYCL library may allocate USM memory for the result that needs to be passed to
Python. A native Python extension that makes use of such a library may expose
this memory as an instance of Python class that will implement memory management
logic (ensures that memory is freed when the instance is no longer needed).
The need to manage memory arises whenever a library uses a custom allocator.
For example, <a class="reference external" href="https://intelpython.github.io/daal4py/"><code class="docutils literal notranslate"><span class="pre">daal4py</span></code></a> uses Python capsule to ensure that a native
library-allocated memory is freed using the appropriate deallocator.</p>
<p>To enable native extensions to pass the memory allocated by a native SYCL
library to Numba, or another SYCL-aware Python extension without making a copy,
the class must provide <code class="docutils literal notranslate"><span class="pre">__sycl_usm_array_interface__</span></code> attribute which
returns a Python dictionary with the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shape</span></code>: tuple of <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">typestr</span></code>: <code class="docutils literal notranslate"><span class="pre">string</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">typedescr</span></code>: a list of tuples</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code>: (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">bool</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">strides</span></code>: tuple of <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">offset</span></code>: <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">version</span></code>: <code class="docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">syclobj</span></code>: <code class="docutils literal notranslate"><span class="pre">dpctl.SyclQueue</span></code> or <code class="docutils literal notranslate"><span class="pre">dpctl.SyclContext</span></code> object</p></li>
</ul>
<p>The dictionary keys align with those of <a class="reference external" href="https://numpy.org/doc/stable/reference/arrays.interface.html"><code class="docutils literal notranslate"><span class="pre">numpy.ndarray.__array_interface__</span></code></a> and <a class="reference external" href="http://numba.pydata.org/numba-doc/latest/cuda/cuda_array_interface.html"><code class="docutils literal notranslate"><span class="pre">__cuda_array_interface__</span></code></a>. For host accessible
USM pointers, the object may also implement CPython
<a class="reference external" href="https://www.python.org/dev/peps/pep-3118/">PEP-3118</a>
compliant buffer interface which will be used if a <code class="docutils literal notranslate"><span class="pre">data</span></code> key is not present
in the dictionary. Use of a buffer interface extends the interoperability to
other Python objects, such as <code class="docutils literal notranslate"><span class="pre">bytes</span></code>, <code class="docutils literal notranslate"><span class="pre">bytearray</span></code>, <code class="docutils literal notranslate"><span class="pre">array.array</span></code>, or
<code class="docutils literal notranslate"><span class="pre">memoryview</span></code>. The type of the USM pointer stored in the object can be queried
using methods of the dpctl.</p>
</section>
<section id="device-only-memory-and-explicit-data-transfer">
<h2>Device-only memory and explicit data transfer<a class="headerlink" href="#device-only-memory-and-explicit-data-transfer" title="Permalink to this heading">¶</a></h2>
<p>At the moment, there is no mechanism for the explicit transfer of arrays to
the device and back. Please use usm arrays.</p>
</section>
<section id="local-memory">
<h2>Local memory<a class="headerlink" href="#local-memory" title="Permalink to this heading">¶</a></h2>
<p>In SYCL’s memory model, local memory is a contiguous region of memory allocated
per work group and is visible to all the work items in that group. Local memory
is device-only and cannot be accessed from the host. From the perspective offers
the device, the local memory is exposed as a contiguous array of a specific
types. The maximum available local memory is hardware-specific. The SYCL local
memory concept is analogous to CUDA’s shared memory concept.</p>
<p>Numba-dpex provides a special function <code class="docutils literal notranslate"><span class="pre">numba_dpex.local.array</span></code> to
allocate local memory for a kernel.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To go convert from <code class="docutils literal notranslate"><span class="pre">numba.cuda</span></code> to <code class="docutils literal notranslate"><span class="pre">numba-dpex</span></code>, replace
<code class="docutils literal notranslate"><span class="pre">numba.cuda.shared.array</span></code> with
<code class="docutils literal notranslate"><span class="pre">numba_dpex.local.array(shape=blocksize,</span> <span class="pre">dtype=float32)</span></code>.</p>
</div>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Add details about current limitations for local memory allocation in
<code class="docutils literal notranslate"><span class="pre">numba-dpex</span></code>.</p>
</div>
</section>
<section id="private-and-constant-memory">
<h2>Private and Constant memory<a class="headerlink" href="#private-and-constant-memory" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">numba-dpex</span></code> does not yet support SYCL private and constant memory.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Table of Contents</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Data Parallel Extension for Numba User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">Prerequisites and installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auto_offload.html">Automatic Offload</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Data Parallel Kernel Programming</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="writing_kernels.html">Writing Data Parallel Kernels</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="synchronization.html">Synchronization Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="device-functions.html">Writing Device Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic-operations.html">Supported Atomic Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="selecting_device.html">Defining the execution queue for a kernel function</a></li>
<li class="toctree-l3"><a class="reference internal" href="memory_allocation_address_space.html">Supported Address Space Qualifiers</a></li>
<li class="toctree-l3"><a class="reference internal" href="reduction.html">Reduction on SYCL-supported Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="ufunc.html">Universal Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="random.html">Random Number Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="supported-python-features.html">Supported Python Features inside <code class="docutils literal notranslate"><span class="pre">numba_dpex.kernel</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tips.html">Performance Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../useful_links.html">Useful links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../useful_links.html#to-do">To-Do</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference_manual/index.html">Data Parallel Extension for Numba Reference Manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">List of examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
</ul>

<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="writing_kernels.html"
                          title="previous chapter">Writing Data Parallel Kernels</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="synchronization.html"
                          title="next chapter">Synchronization Functions</a></p>
  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2022, Intel Corporation.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>